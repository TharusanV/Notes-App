/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';var m=require("@lexical/react/LexicalComposerContext"),n=require("@lexical/utils"),v=require("lexical"),w=require("react"),x="undefined"!==typeof window&&"undefined"!==typeof window.document&&"undefined"!==typeof window.document.createElement?w.useLayoutEffect:w.useEffect;class y{constructor(b){this.key=b;this.ref={current:null};this.setRefElement=this.setRefElement.bind(this)}setRefElement(b){this.ref={current:b}}}
let z=b=>{var a=document.getElementById("typeahead-menu");if(a){a=a.getBoundingClientRect();const c=b.getBoundingClientRect();c.bottom>a.bottom?b.scrollIntoView(!1):c.top<a.top&&b.scrollIntoView()}};function C(b,a){var c=window.getSelection();if(null===c||!c.isCollapsed)return!1;let d=c.anchorNode;c=c.anchorOffset;if(null==d||null==c)return!1;try{a.setStart(d,b),a.setEnd(d,c)}catch(e){return!1}return!0}
function D(b){let a=null;b.getEditorState().read(()=>{var c=v.$getSelection();if(v.$isRangeSelection(c)){var d=c.anchor;"text"!==d.type?a=null:(c=d.getNode(),c.isSimpleText()?(d=d.offset,a=c.getTextContent().slice(0,d)):a=null)}});return a}
function E(b,a){b=v.$getSelection();if(!v.$isRangeSelection(b)||!b.isCollapsed())return null;var c=b.anchor;if("text"!==c.type)return null;b=c.getNode();if(!b.isSimpleText())return null;c=c.offset;let d=b.getTextContent().slice(0,c);var e=a.matchingString;a=a.replaceableString.length;for(let h=a;h<=e.length;h++)d.substr(-h)===e.substr(0,h)&&(a=h);a=c-a;if(0>a)return null;let k;0===a?[k]=b.splitText(c):[,k]=b.splitText(a,c);return k}
function F(b,a){return 0!==a?!1:b.getEditorState().read(()=>{var c=v.$getSelection();return v.$isRangeSelection(c)?(c=c.anchor.getNode().getPreviousSibling(),v.$isTextNode(c)&&c.isTextEntity()):!1})}function G(b){w.startTransition?w.startTransition(b):b()}
function H({close:b,editor:a,anchorElement:c,resolution:d,options:e,menuRenderFn:k,onSelectOption:h}){let [f,p]=w.useState(null);w.useEffect(()=>{p(0)},[d.match.matchingString]);let q=w.useCallback(g=>{a.update(()=>{const l=E(a,d.match);h(g,l,b,d.match.matchingString)})},[b,a,d.match,h]),r=w.useCallback(g=>{const l=a.getRootElement();null!==l&&(l.setAttribute("aria-activedescendant","typeahead-item-"+g),p(g))},[a]);w.useEffect(()=>()=>{let g=a.getRootElement();null!==g&&g.removeAttribute("aria-activedescendant")},
[a]);x(()=>{null===e?p(null):null===f&&r(0)},[e,f,r]);w.useEffect(()=>n.mergeRegister(a.registerCommand(v.KEY_ARROW_DOWN_COMMAND,g=>{if(null!==e&&e.length&&null!==f){var l=f!==e.length-1?f+1:0;r(l);l=e[l];null!=l.ref&&l.ref.current&&z(l.ref.current);g.preventDefault();g.stopImmediatePropagation()}return!0},v.COMMAND_PRIORITY_NORMAL),a.registerCommand(v.KEY_ARROW_UP_COMMAND,g=>{if(null!==e&&e.length&&null!==f){var l=0!==f?f-1:e.length-1;r(l);l=e[l];null!=l.ref&&l.ref.current&&z(l.ref.current);g.preventDefault();
g.stopImmediatePropagation()}return!0},v.COMMAND_PRIORITY_NORMAL),a.registerCommand(v.KEY_ESCAPE_COMMAND,g=>{g.preventDefault();g.stopImmediatePropagation();b();return!0},v.COMMAND_PRIORITY_NORMAL),a.registerCommand(v.KEY_TAB_COMMAND,g=>{if(null===e||null===f||null==e[f])return!1;g.preventDefault();g.stopImmediatePropagation();q(e[f]);return!0},v.COMMAND_PRIORITY_NORMAL),a.registerCommand(v.KEY_ENTER_COMMAND,g=>{if(null===e||null===f||null==e[f])return!1;null!==g&&(g.preventDefault(),g.stopImmediatePropagation());
q(e[f]);return!0},v.COMMAND_PRIORITY_NORMAL)),[q,b,a,e,f,r]);let t=w.useMemo(()=>({selectOptionAndCleanUp:q,selectedIndex:f,setHighlightedIndex:p}),[q,f]);return k(c,t,d.match.matchingString)}
function I(b){let [a]=m.useLexicalComposerContext(),c=w.useRef(document.createElement("div"));w.useEffect(()=>{function d(){let k=c.current;k.setAttribute("aria-label","Typeahead menu");k.setAttribute("id","typeahead-menu");k.setAttribute("role","listbox");if(null!==e&&null!==b){let {left:h,top:f,width:p,height:q}=b.getRect();k.style.top=`${f+q+5+window.pageYOffset}px`;k.style.left=`${h+("start"===b.position?0:p)+window.pageXOffset}px`;k.style.display="block";k.style.position="absolute";k.isConnected||
document.body.append(k);c.current=k;e.setAttribute("aria-controls","typeahead-menu")}}let e=a.getRootElement();if(null!==b)return d(),window.addEventListener("resize",d),()=>{window.removeEventListener("resize",d);null!==e&&e.removeAttribute("aria-controls")}},[a,b]);return c}
exports.LexicalNodeMenuPlugin=function({options:b,nodeKey:a,position:c="end",onClose:d,onSelectOption:e,menuRenderFn:k}){let [h]=m.useLexicalComposerContext(),[f,p]=w.useState(null),q=I(f);w.useEffect(()=>{a&&null==f?h.update(()=>{let r=v.$getNodeByKey(a),t=h.getElementByKey(a);if(null!=r&&null!=t){let g=r.getTextContent();G(()=>p({getRect:()=>t.getBoundingClientRect(),match:{leadOffset:g.length,matchingString:g,replaceableString:g},position:c}))}}):null==a&&null!=f&&p(null)},[h,a,c,f]);return null===
f||null===h?null:w.createElement(H,{close:d,resolution:f,editor:h,anchorElement:q.current,options:b,menuRenderFn:k,onSelectOption:e})};
exports.LexicalTypeaheadMenuPlugin=function({options:b,onQueryChange:a,onSelectOption:c,menuRenderFn:d,triggerFn:e,position:k="start"}){let [h]=m.useLexicalComposerContext(),[f,p]=w.useState(null),q=I(f);w.useEffect(()=>{let t=document.createRange(),g=h.registerUpdateListener(()=>{h.getEditorState().read(()=>{const l=t,A=v.$getSelection(),B=D(h);if(v.$isRangeSelection(A)&&A.isCollapsed()&&null!==B&&null!==l){var u=e(B,h);a(u?u.matchingString:null);null===u||F(h,u.leadOffset)||null===C(u.leadOffset,
l)?p(null):G(()=>p({getRect:()=>l.getBoundingClientRect(),match:u,position:k}))}else p(null)})});return()=>{t=null;g()}},[h,e,a,f,k]);let r=w.useCallback(()=>{p(null)},[]);return null===f||null===h?null:w.createElement(H,{close:r,resolution:f,editor:h,anchorElement:q.current,options:b,menuRenderFn:d,onSelectOption:c})};exports.PUNCTUATION="\\.,\\+\\*\\?\\$\\@\\|#{}\\(\\)\\^\\-\\[\\]\\\\/!%'\"~=<>_:;";exports.TypeaheadOption=y;
exports.useBasicTypeaheadTriggerMatch=function(b,{minLength:a=1,maxLength:c=75}){return w.useCallback(d=>{d=(new RegExp("(^|\\s|\\()(["+b+"]((?:[^"+(b+"\\.,\\+\\*\\?\\$\\@\\|#{}\\(\\)\\^\\-\\[\\]\\\\/!%'\"~=<>_:;\\s]){0,")+c+"}))$")).exec(d);if(null!==d){let e=d[1],k=d[3];if(k.length>=a)return{leadOffset:d.index+e.length,matchingString:k,replaceableString:d[2]}}return null},[c,a,b])}
